<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Biblioteca para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #5636D3; --secondary-color: #FF872C; --success-color: #12A454;
            --danger-color: #E83F5B; --pending-color: #4B90F7; --background-color: #F0F2F5;
            --text-color: #363F5F; --text-light-color: #969CB2; --card-bg-color: #FFFFFF;
            --border-radius: 16px; --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color); display: flex; }
        
        /* --- Layout Geral --- */
        .sidebar { width: 260px; background-color: var(--card-bg-color); height: 100vh; padding: 2rem; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.05); position: fixed; z-index: 1000; transition: transform 0.3s ease-in-out; }
        .main-content { flex-grow: 1; margin-left: 260px; padding: 2rem 3rem; transition: margin-left 0.3s ease-in-out; }
        .page-content { display: none; }
        .page-content.active { display: block; }
        header h2 { font-size: 2rem; font-weight: 500; margin-bottom: 2rem; }

        /* --- Sidebar --- */
        .sidebar .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 3rem; }
        .sidebar .logo i { font-size: 2rem; color: var(--primary-color); }
        .sidebar .logo h1 { font-size: 1.5rem; font-weight: 600; }
        .sidebar nav ul { list-style: none; }
        .sidebar nav li a { display: flex; align-items: center; gap: 15px; padding: 1rem; text-decoration: none; color: var(--text-light-color); font-weight: 500; border-radius: var(--border-radius); transition: all 0.3s ease; cursor: pointer; }
        .sidebar nav li a:hover, .sidebar nav li a.active { background-color: #f0edff; color: var(--primary-color); }
        .sidebar nav li a i { width: 20px; text-align: center; }

        /* --- Elementos Comuns --- */
        .card { background-color: var(--card-bg-color); padding: 1.5rem 2rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        .iphone-card { background-color: var(--card-bg-color); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--card-shadow); margin-bottom: 1.5rem; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .iphone-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); }
        .btn { padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.3s ease; }
        .btn.primary { background-color: var(--primary-color); color: white; }
        .btn.secondary { background-color: #e0e0e0; color: var(--text-color); }
        .btn.success { background-color: var(--success-color); color: white; }
        .btn.danger { background-color: var(--danger-color); color: white; }
        .btn.download { background-color: var(--pending-color); color: white; }
        .btn.edit { background-color: #4B90F7; color: white; }
        .list-item { background-color: var(--card-bg-color); padding: 1rem 1.5rem; margin-bottom: 0.5rem; border-radius: var(--border-radius); display: flex; align-items: center; justify-content: space-between; position: relative; cursor: pointer; transition: background-color 0.2s ease; }
        .list-item:hover { background-color: #f8f9fa; }
        .list-item:hover .delete-btn { opacity: 1; }
        .delete-btn { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1rem; opacity: 0; transition: opacity 0.3s ease; z-index: 5; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

        /* --- Dashboard --- */
        #dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 2rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; color: var(--text-light-color); }
        .card-header i { font-size: 1.8rem; }
        #dashboard-cards .balance i { color: var(--secondary-color); }
        #dashboard-cards .income i { color: var(--success-color); }
        #dashboard-cards .expense i { color: var(--danger-color); }
        .card p { font-size: 2rem; font-weight: 500; }
        #account-balances { margin-bottom: 2rem; }
        #account-balances h3 { font-weight: 500; margin-bottom: 1rem; }
        #account-balances-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .account-card { background: #fff; padding: 1rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        .account-card-header { display: flex; align-items: center; gap: 0.5rem; color: var(--text-light-color); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .account-card-balance { font-size: 1.5rem; font-weight: 500; }

        .transaction-details { display: flex; align-items: center; gap: 1rem; }
        .transaction-status { width: 10px; height: 10px; border-radius: 50%; }
        .transaction-status.completed { background-color: var(--success-color); }
        .transaction-status.pending { background-color: var(--pending-color); }
        .transaction-info span { display: block; }
        .transaction-info .description { font-weight: 500; }
        .transaction-info .details { font-size: 0.8rem; color: var(--text-light-color); }
        .transaction-amount { font-weight: 500; font-size: 1.1rem; }
        .transaction-amount.income { color: var(--success-color); }
        .transaction-amount.expense { color: var(--danger-color); }
        .list-item-actions { display: flex; align-items: center; gap: 1rem; }

        /* --- Páginas de Gerenciamento (Categorias, Contas) --- */
        .management-page .card { margin-bottom: 2rem; }
        .management-page form { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
        .management-page .form-control { flex-grow: 1; min-width: 200px; }
        .management-page label { font-size: 0.9rem; margin-bottom: 0.25rem; display: block;}
        .management-page input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .management-page .list-item i { font-size: 1.2rem; margin-right: 1rem; color: var(--primary-color); }
        .list-item-main { flex-grow: 1; display: flex; align-items: center; }

        /* --- Página Pendentes --- */
        .pending-actions { display: flex; gap: 0.5rem; align-items: center; }
        .confirm-btn { padding: 8px 12px; font-size: 0.9rem; }

        /* --- Página Relatórios --- */
        #reports-page .filters { background-color: #fff; padding: 1.5rem; margin-bottom: 2rem; border-radius: var(--border-radius); display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        #reports-page .filters .form-control { flex-grow: 1; min-width: 200px; }
        #reports-page .filters label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        #reports-page .filters input, #reports-page .filters select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .report-card p { font-size: 1.5rem; }
        .chart-container { background: #fff; padding: 2rem; border-radius: var(--border-radius); margin-bottom: 2rem; }
        
        /* --- Modal e FAB --- */
        .fab { position: fixed; bottom: 2rem; right: 3rem; width: 60px; height: 60px; background-color: var(--primary-color); color: white; border: none; border-radius: 50%; font-size: 2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0,0,0,0.2); cursor: pointer; z-index: 101; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 102; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { background-color: var(--card-bg-color); padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 500px; position: relative; }
        .modal-content h3 { margin-bottom: 1.5rem; }
        .form-control { margin-bottom: 1rem; }
        .form-control label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control input, .form-control select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Poppins', sans-serif; font-size: 1rem; }
        .modal-actions { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }
        .modal-actions .spacer { flex-grow: 1; }
        .form-switch { display: flex; align-items: center; gap: 10px; }

        /* --- Header Mobile --- */
        .mobile-header { display: none; align-items: center; gap: 1rem; padding: 1rem 1.5rem; background-color: var(--card-bg-color); box-shadow: var(--box-shadow); margin-bottom: 1.5rem; }
        .mobile-header #menu-toggle-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-color); cursor: pointer; }
        .mobile-header h2 { font-size: 1.25rem; margin-bottom: 0; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        
        /* --- Dashboard Cards --- */
        .dashboard-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .dashboard-card { background-color: var(--card-bg-color); padding: 1.2rem; border-radius: var(--border-radius); box-shadow: var(--card-shadow); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); }
        .dashboard-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
        .dashboard-card-title { font-size: 0.9rem; font-weight: 500; }
        .dashboard-card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .dashboard-card-content { font-size: 1.4rem; font-weight: 600; margin-bottom: 0.8rem; }
        .dashboard-card-footer { font-size: 0.8rem; color: var(--text-light-color); }
        
        /* --- Cores dos Cards --- */
        .card-1 { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; }
        .card-2 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: white; }
        .card-3 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: var(--text-color); }
        .card-4 { background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); color: var(--text-color); }
        .card-5 { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); color: white; }
        .card-6 { background: linear-gradient(135deg, #fdbb2d 0%, #22c1c3 100%); color: white; }
        
        /* --- Backup Section --- */
        .backup-section { background-color: #fff; padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 2rem; }
        .backup-actions { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
        
        /* --- Metas Section --- */
        .goal-card { background-color: var(--card-bg-color); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--card-shadow); margin-bottom: 1.5rem; }
        .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .goal-progress { margin-top: 1rem; }
        .progress-bar { height: 10px; background-color: #e0e0e0; border-radius: 5px; overflow: hidden; margin-top: 0.5rem; }
        .progress-fill { height: 100%; background-color: var(--success-color); transition: width 0.3s ease; }
        .goal-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .goal-stats { display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-light-color); }
        
        /* --- Responsividade --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 0; }
            .page-content { padding: 0 1.5rem 1.5rem 1.5rem; }
            header { display: none; }
            .mobile-header { display: flex; }
            .form-grid { grid-template-columns: 1fr; }
            .fab { right: 1.5rem; bottom: 1.5rem; }
            .list-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .list-item-actions { width: 100%; justify-content: flex-end; }
            .dashboard-card-grid { grid-template-columns: repeat(2, 1fr); }
            .backup-actions { flex-direction: column; }
        }
        
        @media (max-width: 480px) {
            .dashboard-card-grid { grid-template-columns: 1fr; }
        }

    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <aside class="sidebar" id="sidebar">
        <div class="logo"><i class="fa-solid fa-wallet"></i><h1>Controle Pro</h1></div>
        <nav>
            <ul id="nav-links">
                <li><a data-page="dashboard-page" class="active"><i class="fa-solid fa-chart-pie"></i> Dashboard</a></li>
                <li><a data-page="pending-page"><i class="fa-solid fa-hourglass-half"></i> Pendentes</a></li>
                <li><a data-page="categories-page"><i class="fa-solid fa-tags"></i> Categorias</a></li>
                <li><a data-page="accounts-page"><i class="fa-solid fa-credit-card"></i> Contas</a></li>
                <li><a data-page="goals-page"><i class="fa-solid fa-bullseye"></i> Metas</a></li>
                <li><a data-page="reports-page"><i class="fa-solid fa-chart-line"></i> Relatórios</a></li>
                <li><a data-page="backup-page"><i class="fa-solid fa-download"></i> Backup</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        <header class="mobile-header">
            <button id="menu-toggle-btn"><i class="fa-solid fa-bars"></i></button>
            <h2 id="mobile-page-title">Dashboard</h2>
        </header>

        <section id="dashboard-page" class="page-content active">
            <header><h2>Dashboard</h2></header>
            
            <div class="dashboard-card-grid">
                <div class="dashboard-card card-1" data-target="dashboard-page">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-title">Saldo Geral</div>
                        <div class="dashboard-card-icon"><i class="fa-solid fa-dollar-sign"></i></div>
                    </div>
                    <div class="dashboard-card-content" id="balance-display">R$ 0,00</div>
                    <div class="dashboard-card-footer">Atualizado em tempo real</div>
                </div>
                
                <div class="dashboard-card card-2" data-target="reports-page">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-title">Receitas do Mês</div>
                        <div class="dashboard-card-icon"><i class="fa-solid fa-arrow-up"></i></div>
                    </div>
                    <div class="dashboard-card-content" id="income-display">R$ 0,00</div>
                    <div class="dashboard-card-footer">Baseado nas transações efetivadas</div>
                </div>
                
                <div class="dashboard-card card-3" data-target="reports-page">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-title">Despesas do Mês</div>
                        <div class="dashboard-card-icon"><i class="fa-solid fa-arrow-down"></i></div>
                    </div>
                    <div class="dashboard-card-content" id="expense-display">R$ 0,00</div>
                    <div class="dashboard-card-footer">Baseado nas transações efetivadas</div>
                </div>
                
                <div class="dashboard-card card-4" data-target="pending-page">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-title">Transações Pendentes</div>
                        <div class="dashboard-card-icon"><i class="fa-solid fa-hourglass-half"></i></div>
                    </div>
                    <div class="dashboard-card-content" id="pending-total-display">R$ 0,00</div>
                    <div class="dashboard-card-footer">Total de transações não confirmadas</div>
                </div>
                
                <div class="dashboard-card card-5" data-target="goals-page">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-title">Metas Ativas</div>
                        <div class="dashboard-card-icon"><i class="fa-solid fa-bullseye"></i></div>
                    </div>
                    <div class="dashboard-card-content" id="goals-count-display">0</div>
                    <div class="dashboard-card-footer">Metas financeiras em andamento</div>
                </div>
                
                <div class="dashboard-card card-6" data-target="goals-page">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-title">Economias</div>
                        <div class="dashboard-card-icon"><i class="fa-solid fa-piggy-bank"></i></div>
                    </div>
                    <div class="dashboard-card-content" id="savings-display">R$ 0,00</div>
                    <div class="dashboard-card-footer">Total economizado em metas</div>
                </div>
            </div>
            
            <div id="account-balances">
                <h3>Saldo das Contas</h3>
                <div id="account-balances-list"></div>
            </div>
            
            <div class="iphone-card">
                <h3>Metas em Andamento</h3>
                <ul id="goals-dashboard-list"></ul>
            </div>
            
            <div class="iphone-card">
                <h3>Transações Pendentes</h3>
                <ul id="pending-dashboard-list"></ul>
            </div>
            
            <div class="iphone-card">
                <h3>Próximos Vencimentos</h3>
                <ul id="upcoming-list"></ul>
            </div>
            
            <div id="history">
                <h3>Últimas Transações</h3>
                <ul id="transaction-list"></ul>
            </div>
        </section>
        
        <section id="pending-page" class="page-content">
            <header><h2>Transações Pendentes</h2></header>
            
            <div class="iphone-card">
                <div class="card-header">
                    <span>Resumo das Pendências</span>
                    <span id="pending-summary">Total: R$ 0,00</span>
                </div>
                <ul id="pending-list"></ul>
            </div>
        </section>

        <section id="categories-page" class="page-content management-page">
            <header><h2>Gerenciar Categorias</h2></header>
            <div class="iphone-card">
                <form id="category-form"><div class="form-control"><label for="category-name">Nome da Categoria</label><input type="text" id="category-name" required></div><button type="submit" class="btn primary">Adicionar</button></form>
            </div>
            <ul id="category-list"></ul>
        </section>
        
        <section id="accounts-page" class="page-content management-page">
            <header><h2>Gerenciar Contas</h2></header>
            <div class="iphone-card">
                <form id="account-form">
                    <div class="form-control"><label for="account-name">Nome da Conta</label><input type="text" id="account-name" required></div>
                    <div class="form-control"><label for="account-initial-balance">Saldo Inicial</label><input type="number" id="account-initial-balance" step="0.01" value="0" required></div>
                    <button type="submit" class="btn primary">Adicionar</button>
                </form>
            </div>
            <ul id="account-list"></ul>
        </section>
        
        <section id="goals-page" class="page-content">
            <header><h2>Metas Financeiras</h2></header>
            
            <div class="iphone-card">
                <h3>Criar Nova Meta</h3>
                <form id="goal-form">
                    <div class="form-grid">
                        <div class="form-control"><label for="goal-name">Nome da Meta</label><input type="text" id="goal-name" required></div>
                        <div class="form-control"><label for="goal-target">Valor da Meta (R$)</label><input type="number" id="goal-target" step="0.01" min="0.01" required></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-control"><label for="goal-deadline">Prazo</label><input type="date" id="goal-deadline" required></div>
                        <div class="form-control"><label for="goal-initial-amount">Valor Inicial (R$)</label><input type="number" id="goal-initial-amount" step="0.01" min="0" value="0"></div>
                    </div>
                    <div class="form-control"><label for="goal-description">Descrição (opcional)</label><textarea id="goal-description" rows="2"></textarea></div>
                    <button type="submit" class="btn primary">Criar Meta</button>
                </form>
            </div>
            
            <div id="goals-list"></div>
        </section>

        <section id="reports-page" class="page-content">
            <header><h2>Relatórios</h2></header>
            
            <div class="iphone-card">
                <div class="filters">
                    <div class="form-control"><label for="start-date">Data Início</label><input type="date" id="start-date"></div>
                    <div class="form-control"><label for="end-date">Data Fim</label><input type="date" id="end-date"></div>
                    <div class="form-control"><label for="category-filter">Filtrar por Categoria</label>
                        <select id="category-filter">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>
                    <button class="btn download" id="download-report-btn"><i class="fa-solid fa-download"></i> Baixar Relatório PDF</button>
                </div>
            </div>
            
            <div id="report-summary"></div>
            <div class="chart-container"><h3>Despesas por Categoria</h3><canvas id="expense-chart"></canvas></div>
            <div class="chart-container"><h3>Receitas vs. Despesas</h3><canvas id="flow-chart"></canvas></div>
        </section>
        
        <section id="backup-page" class="page-content">
            <header><h2>Backup e Restauração</h2></header>
            
            <div class="iphone-card">
                <h3>Backup dos Dados</h3>
                <p>Faça backup de todos os seus dados financeiros para garantir que não serão perdidos.</p>
                <div class="backup-actions">
                    <button class="btn primary" id="backup-btn"><i class="fa-solid fa-download"></i> Fazer Backup</button>
                    <button class="btn download" id="download-all-btn"><i class="fa-solid fa-file-download"></i> Baixar Todos os Dados</button>
                </div>
            </div>
            
            <div class="iphone-card">
                <h3>Restaurar Dados</h3>
                <p>Restaurar dados de um backup anterior.</p>
                <div class="backup-actions">
                    <input type="file" id="restore-file" accept=".json" style="display: none;">
                    <button class="btn secondary" id="choose-file-btn"><i class="fa-solid fa-file-upload"></i> Escolher Arquivo</button>
                    <button class="btn success" id="restore-btn" disabled><i class="fa-solid fa-upload"></i> Restaurar Dados</button>
                </div>
                <p id="restore-status" style="margin-top: 1rem; font-size: 0.9rem;"></p>
            </div>
        </section>
    </main>

    <button class="fab" id="fab-add-btn" title="Adicionar Transação"><i class="fa-solid fa-plus"></i></button>
    
    <div class="modal-overlay" id="add-modal-overlay">
        <div class="modal-content">
            <h3>Nova Transação</h3>
            <form id="transaction-form">
                <div class="form-control"><label for="description">Descrição</label><input type="text" id="description" required></div>
                <div class="form-grid">
                    <div class="form-control"><label for="amount">Valor</label><input type="number" id="amount" placeholder="Ex: -50,00 ou 1500,00" step="0.01" required></div>
                    <div class="form-control"><label for="date">Data</label><input type="date" id="date" required></div>
                </div>
                <div class="form-grid">
                    <div class="form-control"><label for="category">Categoria</label><select id="category" required></select></div>
                    <div class="form-control"><label for="account">Conta</label><select id="account" required></select></div>
                </div>
                <div class="form-control form-switch"><input type="checkbox" id="is-pending" style="width: auto;"><label for="is-pending">Marcar como pendente</label></div>
                <div class="modal-actions"><button type="button" class="btn secondary" id="cancel-add-btn">Cancelar</button><button type="submit" class="btn primary">Salvar</button></div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="view-edit-modal-overlay">
        <div class="modal-content">
            <h3>Detalhes da Transação</h3>
            <form id="edit-transaction-form">
                <input type="hidden" id="edit-transaction-id">
                <div class="form-control"><label for="edit-description">Descrição</label><input type="text" id="edit-description" required></div>
                <div class="form-grid">
                    <div class="form-control"><label for="edit-amount">Valor</label><input type="number" id="edit-amount" placeholder="Ex: -50,00 ou 1500,00" step="0.01" required></div>
                    <div class="form-control"><label for="edit-date">Data</label><input type="date" id="edit-date" required></div>
                </div>
                <div class="form-grid">
                    <div class="form-control"><label for="edit-category">Categoria</label><select id="edit-category" required></select></div>
                    <div class="form-control"><label for="edit-account">Conta</label><select id="edit-account" required></select></div>
                </div>
                <div class="form-control form-switch"><input type="checkbox" id="edit-is-pending" style="width: auto;"><label for="edit-is-pending">Transação pendente</label></div>
                <div class="modal-actions">
                    <button type="button" class="btn danger" id="delete-from-modal-btn">Excluir</button>
                    <div class="spacer"></div>
                    <button type="button" class="btn download" id="download-receipt-btn"><i class="fa-solid fa-download"></i> Baixar Recibo PDF</button>
                    <button type="button" class="btn edit" id="edit-transaction-btn"><i class="fa-solid fa-edit"></i> Editar</button>
                    <button type="button" class="btn secondary" id="cancel-edit-btn">Cancelar</button>
                    <button type="submit" class="btn primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal-overlay" id="goal-transfer-modal-overlay">
        <div class="modal-content">
            <h3>Transferir para Meta</h3>
            <form id="goal-transfer-form">
                <input type="hidden" id="transfer-goal-id">
                <div class="form-control"><label for="transfer-amount">Valor para Transferir (R$)</label><input type="number" id="transfer-amount" step="0.01" min="0.01" required></div>
                <div class="form-control"><label for="transfer-from">Transferir de</label><select id="transfer-from" required></select></div>
                <div class="modal-actions">
                    <button type="button" class="btn secondary" id="cancel-transfer-btn">Cancelar</button>
                    <button type="submit" class="btn primary">Transferir</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Inicialização do jsPDF
        const { jsPDF } = window.jspdf;

        // Dados da aplicação
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || [
            { id: 1, name: 'Alimentação' },
            { id: 2, name: 'Transporte' },
            { id: 3, name: 'Moradia' },
            { id: 4, name: 'Saúde' },
            { id: 5, name: 'Lazer' },
            { id: 6, name: 'Educação' },
            { id: 7, name: 'Salário' },
            { id: 8, name: 'Investimentos' }
        ];
        let accounts = JSON.parse(localStorage.getItem('accounts')) || [
            { id: 1, name: 'Carteira', balance: 0 },
            { id: 2, name: 'Conta Corrente', balance: 0 },
            { id: 3, name: 'Poupança', balance: 0 }
        ];
        let goals = JSON.parse(localStorage.getItem('goals')) || [];

        // Elementos DOM
        const navLinks = document.querySelectorAll('#nav-links a');
        const pageContents = document.querySelectorAll('.page-content');
        const fabAddBtn = document.getElementById('fab-add-btn');
        const addModalOverlay = document.getElementById('add-modal-overlay');
        const cancelAddBtn = document.getElementById('cancel-add-btn');
        const transactionForm = document.getElementById('transaction-form');
        const viewEditModalOverlay = document.getElementById('view-edit-modal-overlay');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editTransactionForm = document.getElementById('edit-transaction-form');
        const deleteFromModalBtn = document.getElementById('delete-from-modal-btn');
        const editTransactionBtn = document.getElementById('edit-transaction-btn');
        const categoryForm = document.getElementById('category-form');
        const accountForm = document.getElementById('account-form');
        const goalForm = document.getElementById('goal-form');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobilePageTitle = document.getElementById('mobile-page-title');
        const downloadReportBtn = document.getElementById('download-report-btn');
        const downloadReceiptBtn = document.getElementById('download-receipt-btn');
        const backupBtn = document.getElementById('backup-btn');
        const downloadAllBtn = document.getElementById('download-all-btn');
        const chooseFileBtn = document.getElementById('choose-file-btn');
        const restoreBtn = document.getElementById('restore-btn');
        const restoreFile = document.getElementById('restore-file');
        const restoreStatus = document.getElementById('restore-status');
        const goalTransferModalOverlay = document.getElementById('goal-transfer-modal-overlay');
        const goalTransferForm = document.getElementById('goal-transfer-form');
        const cancelTransferBtn = document.getElementById('cancel-transfer-btn');

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            saveInitialData();
            updateDashboard();
            setupEventListeners();
            loadCategories();
            loadAccounts();
            loadGoals();
            loadTransactions();
            loadPendingTransactions();
            updateReports();
            
            // Configurar data atual como padrão nos formulários
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('goal-deadline').min = today;
            
            // Configurar datas padrão para relatórios (últimos 30 dias)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 30);
            
            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
        });

        // Funções de navegação
        function setupEventListeners() {
            // Navegação entre páginas
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const targetPage = this.getAttribute('data-page');
                    showPage(targetPage);
                    
                    // Atualizar título mobile
                    mobilePageTitle.textContent = this.textContent.trim();
                    
                    // Fechar sidebar no mobile
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('open');
                        sidebarOverlay.classList.remove('active');
                    }
                });
            });

            // Dashboard cards navegáveis
            document.querySelectorAll('.dashboard-card').forEach(card => {
                card.addEventListener('click', function() {
                    const targetPage = this.getAttribute('data-target');
                    if (targetPage) {
                        showPage(targetPage);
                        
                        // Atualizar título mobile
                        const pageTitle = document.querySelector(`[data-page="${targetPage}"]`).textContent.trim();
                        mobilePageTitle.textContent = pageTitle;
                    }
                });
            });

            // Botão menu mobile
            menuToggleBtn.addEventListener('click', function() {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('active');
            });

            // Overlay para fechar sidebar no mobile
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('active');
            });

            // FAB para adicionar transação
            fabAddBtn.addEventListener('click', function() {
                addModalOverlay.classList.add('active');
            });

            // Cancelar adição de transação
            cancelAddBtn.addEventListener('click', function() {
                addModalOverlay.classList.remove('active');
                transactionForm.reset();
            });

            // Formulário de transação
            transactionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addTransaction();
            });

            // Cancelar edição de transação
            cancelEditBtn.addEventListener('click', function() {
                viewEditModalOverlay.classList.remove('active');
                editTransactionForm.reset();
            });

            // Formulário de edição de transação
            editTransactionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveTransactionEdit();
            });

            // Botão editar transação
            editTransactionBtn.addEventListener('click', function() {
                document.getElementById('edit-description').removeAttribute('readonly');
                document.getElementById('edit-amount').removeAttribute('readonly');
                document.getElementById('edit-date').removeAttribute('readonly');
                document.getElementById('edit-category').removeAttribute('disabled');
                document.getElementById('edit-account').removeAttribute('disabled');
                document.getElementById('edit-is-pending').removeAttribute('disabled');
                
                editTransactionBtn.style.display = 'none';
                document.querySelector('#view-edit-modal-overlay .btn.primary').style.display = 'block';
            });

            // Botão excluir transação do modal
            deleteFromModalBtn.addEventListener('click', function() {
                const transactionId = parseInt(document.getElementById('edit-transaction-id').value);
                deleteTransaction(transactionId);
                viewEditModalOverlay.classList.remove('active');
            });

            // Formulário de categoria
            categoryForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addCategory();
            });

            // Formulário de conta
            accountForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addAccount();
            });

            // Formulário de meta
            goalForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addGoal();
            });

            // Filtros de relatórios
            document.getElementById('start-date').addEventListener('change', updateReports);
            document.getElementById('end-date').addEventListener('change', updateReports);
            document.getElementById('category-filter').addEventListener('change', updateReports);

            // Botão de download de relatório
            downloadReportBtn.addEventListener('click', downloadReportPDF);

            // Botão de download de recibo
            downloadReceiptBtn.addEventListener('click', downloadReceipt);

            // Botão de backup
            backupBtn.addEventListener('click', createBackup);

            // Botão de download de todos os dados
            downloadAllBtn.addEventListener('click', downloadAllData);

            // Botão de escolher arquivo para restauração
            chooseFileBtn.addEventListener('click', function() {
                restoreFile.click();
            });

            // Input de arquivo para restauração
            restoreFile.addEventListener('change', function() {
                if (this.files.length > 0) {
                    restoreBtn.disabled = false;
                    restoreStatus.textContent = `Arquivo selecionado: ${this.files[0].name}`;
                    restoreStatus.style.color = 'var(--success-color)';
                } else {
                    restoreBtn.disabled = true;
                    restoreStatus.textContent = '';
                }
            });

            // Botão de restauração
            restoreBtn.addEventListener('click', restoreData);

            // Formulário de transferência para meta
            goalTransferForm.addEventListener('submit', function(e) {
                e.preventDefault();
                transferToGoal();
            });

            // Cancelar transferência para meta
            cancelTransferBtn.addEventListener('click', function() {
                goalTransferModalOverlay.classList.remove('active');
                goalTransferForm.reset();
            });
        }

        function showPage(pageId) {
            // Esconder todas as páginas
            pageContents.forEach(page => {
                page.classList.remove('active');
            });
            
            // Mostrar a página selecionada
            document.getElementById(pageId).classList.add('active');
            
            // Atualizar navegação ativa
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === pageId) {
                    link.classList.add('active');
                }
            });
            
            // Atualizar dados específicos da página
            if (pageId === 'reports-page') {
                updateReports();
            } else if (pageId === 'pending-page') {
                loadPendingTransactions();
            } else if (pageId === 'goals-page') {
                loadGoals();
            }
        }

        // Funções de dados
        function saveInitialData() {
            if (!localStorage.getItem('categories')) {
                localStorage.setItem('categories', JSON.stringify(categories));
            }
            if (!localStorage.getItem('accounts')) {
                localStorage.setItem('accounts', JSON.stringify(accounts));
            }
            if (!localStorage.getItem('transactions')) {
                localStorage.setItem('transactions', JSON.stringify(transactions));
            }
            if (!localStorage.getItem('goals')) {
                localStorage.setItem('goals', JSON.stringify(goals));
            }
        }

        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('categories', JSON.stringify(categories));
            localStorage.setItem('accounts', JSON.stringify(accounts));
            localStorage.setItem('goals', JSON.stringify(goals));
            updateDashboard();
        }

        // Funções de transações
        function addTransaction() {
            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const date = document.getElementById('date').value;
            const categoryId = parseInt(document.getElementById('category').value);
            const accountId = parseInt(document.getElementById('account').value);
            const isPending = document.getElementById('is-pending').checked;

            const transaction = {
                id: Date.now(),
                description,
                amount,
                date,
                categoryId,
                accountId,
                isPending,
                createdAt: new Date().toISOString()
            };

            transactions.push(transaction);
            
            // Atualizar saldo da conta se não for pendente
            if (!isPending) {
                updateAccountBalance(accountId, amount);
            }
            
            saveData();
            loadTransactions();
            loadPendingTransactions();
            addModalOverlay.classList.remove('active');
            transactionForm.reset();
            
            // Resetar data para hoje
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
        }

        function updateAccountBalance(accountId, amount) {
            const account = accounts.find(acc => acc.id === accountId);
            if (account) {
                account.balance += amount;
                localStorage.setItem('accounts', JSON.stringify(accounts));
            }
        }

        function loadTransactions() {
            const transactionList = document.getElementById('transaction-list');
            transactionList.innerHTML = '';
            
            // Ordenar transações por data (mais recente primeiro)
            const sortedTransactions = [...transactions]
                .filter(t => !t.isPending)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10); // Mostrar apenas as 10 mais recentes
            
            sortedTransactions.forEach(transaction => {
                const category = categories.find(c => c.id === transaction.categoryId);
                const account = accounts.find(a => a.id === transaction.accountId);
                
                const li = document.createElement('li');
                li.className = 'list-item';
                li.setAttribute('data-id', transaction.id);
                
                li.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-status completed"></div>
                        <div class="transaction-info">
                            <span class="description">${transaction.description}</span>
                            <span class="details">${category ? category.name : 'Sem categoria'} • ${account ? account.name : 'Sem conta'} • ${formatDate(transaction.date)}</span>
                        </div>
                    </div>
                    <div class="transaction-amount ${transaction.amount >= 0 ? 'income' : 'expense'}">
                        ${formatCurrency(transaction.amount)}
                    </div>
                    <div class="list-item-actions">
                        <button class="btn edit view-transaction-btn" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button>
                        <button class="delete-btn" title="Excluir transação"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                
                transactionList.appendChild(li);
                
                // Adicionar eventos
                li.querySelector('.view-transaction-btn').addEventListener('click', function() {
                    viewTransaction(transaction.id);
                });
                
                li.querySelector('.delete-btn').addEventListener('click', function() {
                    deleteTransaction(transaction.id);
                });
            });
        }

        function loadPendingTransactions() {
            const pendingList = document.getElementById('pending-list');
            const pendingDashboardList = document.getElementById('pending-dashboard-list');
            
            pendingList.innerHTML = '';
            pendingDashboardList.innerHTML = '';
            
            const pendingTransactions = transactions.filter(t => t.isPending);
            let pendingTotal = 0;
            
            if (pendingTransactions.length === 0) {
                pendingList.innerHTML = '<li class="list-item">Nenhuma transação pendente</li>';
                pendingDashboardList.innerHTML = '<li class="list-item">Nenhuma transação pendente</li>';
                document.getElementById('pending-summary').textContent = 'Total: R$ 0,00';
                return;
            }
            
            pendingTransactions.forEach(transaction => {
                pendingTotal += transaction.amount;
                
                const category = categories.find(c => c.id === transaction.categoryId);
                const account = accounts.find(a => a.id === transaction.accountId);
                
                const li = document.createElement('li');
                li.className = 'list-item';
                li.setAttribute('data-id', transaction.id);
                
                li.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-status pending"></div>
                        <div class="transaction-info">
                            <span class="description">${transaction.description}</span>
                            <span class="details">${category ? category.name : 'Sem categoria'} • ${account ? account.name : 'Sem conta'} • ${formatDate(transaction.date)}</span>
                        </div>
                    </div>
                    <div class="transaction-amount ${transaction.amount >= 0 ? 'income' : 'expense'}">
                        ${formatCurrency(transaction.amount)}
                    </div>
                    <div class="list-item-actions">
                        <div class="pending-actions">
                            <button class="btn success confirm-btn" title="Confirmar transação"><i class="fa-solid fa-check"></i></button>
                            <button class="btn edit view-transaction-btn" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button>
                            <button class="delete-btn" title="Excluir transação"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
                
                pendingList.appendChild(li);
                
                // Versão simplificada para o dashboard
                const dashboardLi = document.createElement('li');
                dashboardLi.className = 'list-item';
                dashboardLi.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-status pending"></div>
                        <div class="transaction-info">
                            <span class="description">${transaction.description}</span>
                            <span class="details">${formatCurrency(transaction.amount)} • ${formatDate(transaction.date)}</span>
                        </div>
                    </div>
                `;
                pendingDashboardList.appendChild(dashboardLi);
                
                // Adicionar eventos
                li.querySelector('.confirm-btn').addEventListener('click', function() {
                    confirmTransaction(transaction.id);
                });
                
                li.querySelector('.view-transaction-btn').addEventListener('click', function() {
                    viewTransaction(transaction.id);
                });
                
                li.querySelector('.delete-btn').addEventListener('click', function() {
                    deleteTransaction(transaction.id);
                });
            });
            
            document.getElementById('pending-summary').textContent = `Total: ${formatCurrency(pendingTotal)}`;
            document.getElementById('pending-total-display').textContent = formatCurrency(pendingTotal);
        }

        function confirmTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (transaction) {
                transaction.isPending = false;
                updateAccountBalance(transaction.accountId, transaction.amount);
                saveData();
                loadPendingTransactions();
                loadTransactions();
            }
        }

        function viewTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;
            
            const category = categories.find(c => c.id === transaction.categoryId);
            const account = accounts.find(a => a.id === transaction.accountId);
            
            // Preencher formulário de edição
            document.getElementById('edit-transaction-id').value = transaction.id;
            document.getElementById('edit-description').value = transaction.description;
            document.getElementById('edit-amount').value = transaction.amount;
            document.getElementById('edit-date').value = transaction.date;
            document.getElementById('edit-is-pending').checked = transaction.isPending;
            
            // Carregar categorias e contas nos selects
            loadCategories('edit-category');
            loadAccounts('edit-account');
            
            // Selecionar a categoria e conta corretas
            document.getElementById('edit-category').value = transaction.categoryId;
            document.getElementById('edit-account').value = transaction.accountId;
            
            // Configurar campos como somente leitura inicialmente
            document.getElementById('edit-description').setAttribute('readonly', true);
            document.getElementById('edit-amount').setAttribute('readonly', true);
            document.getElementById('edit-date').setAttribute('readonly', true);
            document.getElementById('edit-category').setAttribute('disabled', true);
            document.getElementById('edit-account').setAttribute('disabled', true);
            document.getElementById('edit-is-pending').setAttribute('disabled', true);
            
            // Mostrar botão editar e esconder botão salvar
            editTransactionBtn.style.display = 'block';
            document.querySelector('#view-edit-modal-overlay .btn.primary').style.display = 'none';
            
            // Mostrar modal
            viewEditModalOverlay.classList.add('active');
        }

        function saveTransactionEdit() {
            const id = parseInt(document.getElementById('edit-transaction-id').value);
            const transaction = transactions.find(t => t.id === id);
            
            if (!transaction) return;
            
            const oldAmount = transaction.amount;
            const oldAccountId = transaction.accountId;
            const oldIsPending = transaction.isPending;
            
            // Obter novos valores
            transaction.description = document.getElementById('edit-description').value;
            transaction.amount = parseFloat(document.getElementById('edit-amount').value);
            transaction.date = document.getElementById('edit-date').value;
            transaction.categoryId = parseInt(document.getElementById('edit-category').value);
            transaction.accountId = parseInt(document.getElementById('edit-account').value);
            transaction.isPending = document.getElementById('edit-is-pending').checked;
            
            // Atualizar saldos das contas se necessário
            if (!oldIsPending && !transaction.isPending) {
                // Se ambas não são pendentes, ajustar saldos
                if (oldAccountId !== transaction.accountId) {
                    // Conta mudou - reverter da conta antiga e adicionar na nova
                    updateAccountBalance(oldAccountId, -oldAmount);
                    updateAccountBalance(transaction.accountId, transaction.amount);
                } else if (oldAmount !== transaction.amount) {
                    // Mesma conta, valor mudou - ajustar diferença
                    updateAccountBalance(transaction.accountId, transaction.amount - oldAmount);
                }
            } else if (oldIsPending && !transaction.isPending) {
                // De pendente para confirmada - adicionar à conta
                updateAccountBalance(transaction.accountId, transaction.amount);
            } else if (!oldIsPending && transaction.isPending) {
                // De confirmada para pendente - reverter da conta
                updateAccountBalance(transaction.accountId, -transaction.amount);
            }
            
            saveData();
            loadTransactions();
            loadPendingTransactions();
            viewEditModalOverlay.classList.remove('active');
        }

        function deleteTransaction(id) {
            if (!confirm('Tem certeza que deseja excluir esta transação?')) {
                return;
            }
            
            const transaction = transactions.find(t => t.id === id);
            if (transaction && !transaction.isPending) {
                // Reverter o saldo da conta se a transação estava confirmada
                updateAccountBalance(transaction.accountId, -transaction.amount);
            }
            
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            loadTransactions();
            loadPendingTransactions();
        }

        // Funções de categorias
        function loadCategories(selectId = 'category') {
            const select = document.getElementById(selectId);
            const categoryFilter = document.getElementById('category-filter');
            
            if (select) {
                select.innerHTML = '<option value="">Selecione uma categoria</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
            }
            
            if (categoryFilter && selectId === 'category') {
                categoryFilter.innerHTML = '<option value="">Todas as categorias</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categoryFilter.appendChild(option);
                });
            }
            
            // Atualizar lista de categorias
            const categoryList = document.getElementById('category-list');
            if (categoryList) {
                categoryList.innerHTML = '';
                
                if (categories.length === 0) {
                    categoryList.innerHTML = '<li class="list-item">Nenhuma categoria cadastrada</li>';
                    return;
                }
                
                categories.forEach(category => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.setAttribute('data-id', category.id);
                    
                    li.innerHTML = `
                        <div class="list-item-main">
                            <i class="fa-solid fa-tag"></i>
                            <span>${category.name}</span>
                        </div>
                        <button class="delete-btn" title="Excluir categoria"><i class="fa-solid fa-trash"></i></button>
                    `;
                    
                    categoryList.appendChild(li);
                    
                    li.querySelector('.delete-btn').addEventListener('click', function() {
                        deleteCategory(category.id);
                    });
                });
            }
        }

        function addCategory() {
            const nameInput = document.getElementById('category-name');
            const name = nameInput.value.trim();
            
            if (!name) return;
            
            // Verificar se já existe
            if (categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                alert('Já existe uma categoria com este nome!');
                return;
            }
            
            const newCategory = {
                id: Date.now(),
                name: name
            };
            
            categories.push(newCategory);
            saveData();
            loadCategories();
            nameInput.value = '';
        }

        function deleteCategory(id) {
            // Verificar se existem transações usando esta categoria
            const transactionsUsingCategory = transactions.filter(t => t.categoryId === id);
            
            if (transactionsUsingCategory.length > 0) {
                alert('Não é possível excluir esta categoria pois existem transações vinculadas a ela!');
                return;
            }
            
            if (!confirm('Tem certeza que deseja excluir esta categoria?')) {
                return;
            }
            
            categories = categories.filter(c => c.id !== id);
            saveData();
            loadCategories();
        }

        // Funções de contas
        function loadAccounts(selectId = 'account') {
            const select = document.getElementById(selectId);
            const transferFromSelect = document.getElementById('transfer-from');
            
            if (select) {
                select.innerHTML = '<option value="">Selecione uma conta</option>';
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.name} (${formatCurrency(account.balance)})`;
                    select.appendChild(option);
                });
            }
            
            if (transferFromSelect && selectId === 'account') {
                transferFromSelect.innerHTML = '<option value="">Selecione uma conta</option>';
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.name} (${formatCurrency(account.balance)})`;
                    transferFromSelect.appendChild(option);
                });
            }
            
            // Atualizar lista de contas
            const accountList = document.getElementById('account-list');
            const accountBalancesList = document.getElementById('account-balances-list');
            
            if (accountList) {
                accountList.innerHTML = '';
                
                if (accounts.length === 0) {
                    accountList.innerHTML = '<li class="list-item">Nenhuma conta cadastrada</li>';
                    return;
                }
                
                accounts.forEach(account => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.setAttribute('data-id', account.id);
                    
                    li.innerHTML = `
                        <div class="list-item-main">
                            <i class="fa-solid fa-credit-card"></i>
                            <span>${account.name} - ${formatCurrency(account.balance)}</span>
                        </div>
                        <button class="delete-btn" title="Excluir conta"><i class="fa-solid fa-trash"></i></button>
                    `;
                    
                    accountList.appendChild(li);
                    
                    li.querySelector('.delete-btn').addEventListener('click', function() {
                        deleteAccount(account.id);
                    });
                });
            }
            
            // Atualizar saldos no dashboard
            if (accountBalancesList) {
                accountBalancesList.innerHTML = '';
                
                accounts.forEach(account => {
                    const accountCard = document.createElement('div');
                    accountCard.className = 'account-card';
                    
                    accountCard.innerHTML = `
                        <div class="account-card-header">
                            <i class="fa-solid fa-credit-card"></i>
                            <span>${account.name}</span>
                        </div>
                        <div class="account-card-balance">${formatCurrency(account.balance)}</div>
                    `;
                    
                    accountBalancesList.appendChild(accountCard);
                });
            }
        }

        function addAccount() {
            const nameInput = document.getElementById('account-name');
            const balanceInput = document.getElementById('account-initial-balance');
            
            const name = nameInput.value.trim();
            const balance = parseFloat(balanceInput.value) || 0;
            
            if (!name) return;
            
            // Verificar se já existe
            if (accounts.some(a => a.name.toLowerCase() === name.toLowerCase())) {
                alert('Já existe uma conta com este nome!');
                return;
            }
            
            const newAccount = {
                id: Date.now(),
                name: name,
                balance: balance
            };
            
            accounts.push(newAccount);
            saveData();
            loadAccounts();
            nameInput.value = '';
            balanceInput.value = '0';
        }

        function deleteAccount(id) {
            // Verificar se existem transações usando esta conta
            const transactionsUsingAccount = transactions.filter(t => t.accountId === id);
            
            if (transactionsUsingAccount.length > 0) {
                alert('Não é possível excluir esta conta pois existem transações vinculadas a ela!');
                return;
            }
            
            if (!confirm('Tem certeza que deseja excluir esta conta?')) {
                return;
            }
            
            accounts = accounts.filter(a => a.id !== id);
            saveData();
            loadAccounts();
        }

        // Funções de metas
        function loadGoals() {
            const goalsList = document.getElementById('goals-list');
            const goalsDashboardList = document.getElementById('goals-dashboard-list');
            
            if (goalsList) {
                goalsList.innerHTML = '';
                
                if (goals.length === 0) {
                    goalsList.innerHTML = '<div class="iphone-card"><p>Nenhuma meta financeira cadastrada.</p></div>';
                    return;
                }
                
                goals.forEach(goal => {
                    const progress = (goal.currentAmount / goal.targetAmount) * 100;
                    const daysLeft = calculateDaysLeft(goal.deadline);
                    
                    const goalCard = document.createElement('div');
                    goalCard.className = 'goal-card';
                    goalCard.setAttribute('data-id', goal.id);
                    
                    goalCard.innerHTML = `
                        <div class="goal-header">
                            <h4>${goal.name}</h4>
                            <span class="goal-amount">${formatCurrency(goal.currentAmount)} / ${formatCurrency(goal.targetAmount)}</span>
                        </div>
                        <p>${goal.description || 'Sem descrição'}</p>
                        <div class="goal-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                            </div>
                            <div class="goal-stats">
                                <span>${progress.toFixed(1)}% concluído</span>
                                <span>${daysLeft > 0 ? `${daysLeft} dias restantes` : 'Prazo expirado'}</span>
                            </div>
                        </div>
                        <div class="goal-actions">
                            <button class="btn primary transfer-to-goal-btn" data-id="${goal.id}">Transferir</button>
                            <button class="btn edit edit-goal-btn" data-id="${goal.id}">Editar</button>
                            <button class="btn danger delete-goal-btn" data-id="${goal.id}">Excluir</button>
                        </div>
                    `;
                    
                    goalsList.appendChild(goalCard);
                });
            }
            
            // Atualizar lista de metas no dashboard
            if (goalsDashboardList) {
                goalsDashboardList.innerHTML = '';
                
                const activeGoals = goals.filter(goal => {
                    const progress = (goal.currentAmount / goal.targetAmount) * 100;
                    return progress < 100;
                }).slice(0, 3); // Mostrar apenas 3 metas no dashboard
                
                if (activeGoals.length === 0) {
                    goalsDashboardList.innerHTML = '<li class="list-item">Nenhuma meta ativa</li>';
                    return;
                }
                
                activeGoals.forEach(goal => {
                    const progress = (goal.currentAmount / goal.targetAmount) * 100;
                    
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    
                    li.innerHTML = `
                        <div class="transaction-details">
                            <div class="transaction-info">
                                <span class="description">${goal.name}</span>
                                <span class="details">${formatCurrency(goal.currentAmount)} / ${formatCurrency(goal.targetAmount)} (${progress.toFixed(1)}%)</span>
                            </div>
                        </div>
                    `;
                    
                    goalsDashboardList.appendChild(li);
                });
            }
            
            // Atualizar contadores no dashboard
            document.getElementById('goals-count-display').textContent = goals.filter(g => (g.currentAmount / g.targetAmount) * 100 < 100).length;
            
            const totalSavings = goals.reduce((total, goal) => total + goal.currentAmount, 0);
            document.getElementById('savings-display').textContent = formatCurrency(totalSavings);
            
            // Adicionar eventos aos botões das metas
            document.querySelectorAll('.transfer-to-goal-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const goalId = parseInt(this.getAttribute('data-id'));
                    openTransferModal(goalId);
                });
            });
            
            document.querySelectorAll('.edit-goal-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const goalId = parseInt(this.getAttribute('data-id'));
                    editGoal(goalId);
                });
            });
            
            document.querySelectorAll('.delete-goal-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const goalId = parseInt(this.getAttribute('data-id'));
                    deleteGoal(goalId);
                });
            });
        }

        function addGoal() {
            const nameInput = document.getElementById('goal-name');
            const targetInput = document.getElementById('goal-target');
            const deadlineInput = document.getElementById('goal-deadline');
            const initialAmountInput = document.getElementById('goal-initial-amount');
            const descriptionInput = document.getElementById('goal-description');
            
            const name = nameInput.value.trim();
            const targetAmount = parseFloat(targetInput.value);
            const deadline = deadlineInput.value;
            const initialAmount = parseFloat(initialAmountInput.value) || 0;
            const description = descriptionInput.value.trim();
            
            if (!name || !targetAmount || !deadline) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }
            
            if (targetAmount <= 0) {
                alert('O valor da meta deve ser maior que zero!');
                return;
            }
            
            if (initialAmount > targetAmount) {
                alert('O valor inicial não pode ser maior que o valor da meta!');
                return;
            }
            
            const newGoal = {
                id: Date.now(),
                name: name,
                targetAmount: targetAmount,
                currentAmount: initialAmount,
                deadline: deadline,
                description: description,
                createdAt: new Date().toISOString()
            };
            
            goals.push(newGoal);
            saveData();
            loadGoals();
            goalForm.reset();
            
            // Resetar data mínima para hoje
            document.getElementById('goal-deadline').min = new Date().toISOString().split('T')[0];
        }

        function editGoal(id) {
            const goal = goals.find(g => g.id === id);
            if (!goal) return;
            
            const newName = prompt('Novo nome da meta:', goal.name);
            if (newName === null) return;
            
            const newTarget = parseFloat(prompt('Novo valor da meta:', goal.targetAmount));
            if (isNaN(newTarget) || newTarget <= 0) {
                alert('Valor inválido!');
                return;
            }
            
            goal.name = newName.trim();
            goal.targetAmount = newTarget;
            
            saveData();
            loadGoals();
        }

        function deleteGoal(id) {
            if (!confirm('Tem certeza que deseja excluir esta meta?')) {
                return;
            }
            
            goals = goals.filter(g => g.id !== id);
            saveData();
            loadGoals();
        }

        function openTransferModal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            document.getElementById('transfer-goal-id').value = goalId;
            loadAccounts('transfer-from');
            goalTransferModalOverlay.classList.add('active');
        }

        function transferToGoal() {
            const goalId = parseInt(document.getElementById('transfer-goal-id').value);
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            const fromAccountId = parseInt(document.getElementById('transfer-from').value);
            
            const goal = goals.find(g => g.id === goalId);
            const account = accounts.find(a => a.id === fromAccountId);
            
            if (!goal || !account) {
                alert('Erro ao processar transferência!');
                return;
            }
            
            if (amount <= 0) {
                alert('O valor da transferência deve ser maior que zero!');
                return;
            }
            
            if (account.balance < amount) {
                alert('Saldo insuficiente na conta selecionada!');
                return;
            }
            
            if (goal.currentAmount + amount > goal.targetAmount) {
                alert('Esta transferência excederia o valor da meta!');
                return;
            }
            
            // Realizar transferência
            goal.currentAmount += amount;
            account.balance -= amount;
            
            // Registrar transação de transferência
            const transferTransaction = {
                id: Date.now(),
                description: `Transferência para meta: ${goal.name}`,
                amount: -amount,
                date: new Date().toISOString().split('T')[0],
                categoryId: categories.find(c => c.name === 'Investimentos')?.id || categories[0].id,
                accountId: fromAccountId,
                isPending: false,
                createdAt: new Date().toISOString(),
                isTransfer: true
            };
            
            transactions.push(transferTransaction);
            
            saveData();
            loadGoals();
            loadAccounts();
            goalTransferModalOverlay.classList.remove('active');
            goalTransferForm.reset();
            
            alert(`Transferência de ${formatCurrency(amount)} realizada com sucesso para a meta "${goal.name}"!`);
        }

        // Funções do dashboard
        function updateDashboard() {
            // Calcular totais
            const totalIncome = transactions
                .filter(t => !t.isPending && t.amount > 0)
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalExpense = transactions
                .filter(t => !t.isPending && t.amount < 0)
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalBalance = totalIncome + totalExpense;
            
            // Atualizar displays
            document.getElementById('balance-display').textContent = formatCurrency(totalBalance);
            document.getElementById('income-display').textContent = formatCurrency(totalIncome);
            document.getElementById('expense-display').textContent = formatCurrency(Math.abs(totalExpense));
            
            // Atualizar próximos vencimentos
            loadUpcomingTransactions();
        }

        function loadUpcomingTransactions() {
            const upcomingList = document.getElementById('upcoming-list');
            upcomingList.innerHTML = '';
            
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            const upcomingTransactions = transactions
                .filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= today && transactionDate <= nextWeek && !t.isPending;
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 5);
            
            if (upcomingTransactions.length === 0) {
                upcomingList.innerHTML = '<li class="list-item">Nenhum vencimento na próxima semana</li>';
                return;
            }
            
            upcomingTransactions.forEach(transaction => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                li.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-info">
                            <span class="description">${transaction.description}</span>
                            <span class="details">${formatDate(transaction.date)}</span>
                        </div>
                    </div>
                    <div class="transaction-amount ${transaction.amount >= 0 ? 'income' : 'expense'}">
                        ${formatCurrency(transaction.amount)}
                    </div>
                `;
                
                upcomingList.appendChild(li);
            });
        }

        // Funções de relatórios
        function updateReports() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const categoryFilter = document.getElementById('category-filter').value;
            
            if (!startDate || !endDate) {
                return;
            }
            
            // Filtrar transações
            let filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999); // Incluir todo o dia final
                
                return transactionDate >= start && 
                       transactionDate <= end && 
                       !t.isPending &&
                       (categoryFilter === '' || t.categoryId.toString() === categoryFilter);
            });
            
            // Calcular totais
            const income = filteredTransactions
                .filter(t => t.amount > 0)
                .reduce((sum, t) => sum + t.amount, 0);
                
            const expense = filteredTransactions
                .filter(t => t.amount < 0)
                .reduce((sum, t) => sum + t.amount, 0);
                
            const balance = income + expense;
            const transactionCount = filteredTransactions.length;
            
            // Atualizar resumo
            const reportSummary = document.getElementById('report-summary');
            reportSummary.innerHTML = `
                <div class="report-card card">
                    <div class="card-header">
                        <span>Receitas</span>
                        <i class="fa-solid fa-arrow-up"></i>
                    </div>
                    <p style="color: var(--success-color);">${formatCurrency(income)}</p>
                </div>
                <div class="report-card card">
                    <div class="card-header">
                        <span>Despesas</span>
                        <i class="fa-solid fa-arrow-down"></i>
                    </div>
                    <p style="color: var(--danger-color);">${formatCurrency(Math.abs(expense))}</p>
                </div>
                <div class="report-card card">
                    <div class="card-header">
                        <span>Saldo</span>
                        <i class="fa-solid fa-dollar-sign"></i>
                    </div>
                    <p style="color: ${balance >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${formatCurrency(balance)}</p>
                </div>
                <div class="report-card card">
                    <div class="card-header">
                        <span>Transações</span>
                        <i class="fa-solid fa-list"></i>
                    </div>
                    <p>${transactionCount}</p>
                </div>
            `;
            
            // Atualizar gráficos
            updateCharts(filteredTransactions);
        }

        function updateCharts(transactions) {
            // Gráfico de despesas por categoria
            const expenseCtx = document.getElementById('expense-chart').getContext('2d');
            
            // Agrupar despesas por categoria
            const expenseByCategory = {};
            transactions
                .filter(t => t.amount < 0)
                .forEach(t => {
                    const category = categories.find(c => c.id === t.categoryId);
                    const categoryName = category ? category.name : 'Outros';
                    
                    if (!expenseByCategory[categoryName]) {
                        expenseByCategory[categoryName] = 0;
                    }
                    
                    expenseByCategory[categoryName] += Math.abs(t.amount);
                });
            
            const expenseLabels = Object.keys(expenseByCategory);
            const expenseData = Object.values(expenseByCategory);
            
            // Destruir gráfico anterior se existir
            if (window.expenseChartInstance) {
                window.expenseChartInstance.destroy();
            }
            
            if (expenseLabels.length > 0) {
                window.expenseChartInstance = new Chart(expenseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: expenseLabels,
                        datasets: [{
                            data: expenseData,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                                '#9966FF', '#FF9F40', '#8AC926', '#1982C4'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Distribuição de Despesas por Categoria'
                            }
                        }
                    }
                });
            } else {
                expenseCtx.font = '16px Poppins';
                expenseCtx.fillStyle = '#969CB2';
                expenseCtx.textAlign = 'center';
                expenseCtx.fillText('Nenhuma despesa no período', expenseCtx.canvas.width / 2, expenseCtx.canvas.height / 2);
            }
            
            // Gráfico de fluxo (receitas vs despesas)
            const flowCtx = document.getElementById('flow-chart').getContext('2d');
            
            // Agrupar por mês
            const monthlyData = {};
            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { income: 0, expense: 0 };
                }
                
                if (t.amount > 0) {
                    monthlyData[monthYear].income += t.amount;
                } else {
                    monthlyData[monthYear].expense += Math.abs(t.amount);
                }
            });
            
            const months = Object.keys(monthlyData).sort();
            const incomeData = months.map(month => monthlyData[month].income);
            const expenseDataMonthly = months.map(month => monthlyData[month].expense);
            
            // Destruir gráfico anterior se existir
            if (window.flowChartInstance) {
                window.flowChartInstance.destroy();
            }
            
            if (months.length > 0) {
                window.flowChartInstance = new Chart(flowCtx, {
                    type: 'bar',
                    data: {
                        labels: months.map(month => {
                            const [year, monthNum] = month.split('-');
                            return `${monthNum}/${year}`;
                        }),
                        datasets: [
                            {
                                label: 'Receitas',
                                data: incomeData,
                                backgroundColor: 'rgba(18, 164, 84, 0.7)',
                                borderColor: 'rgba(18, 164, 84, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Despesas',
                                data: expenseDataMonthly,
                                backgroundColor: 'rgba(232, 63, 91, 0.7)',
                                borderColor: 'rgba(232, 63, 91, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Receitas vs Despesas por Mês'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += formatCurrency(context.parsed.y);
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                flowCtx.font = '16px Poppins';
                flowCtx.fillStyle = '#969CB2';
                flowCtx.textAlign = 'center';
                flowCtx.fillText('Nenhuma transação no período', flowCtx.canvas.width / 2, flowCtx.canvas.height / 2);
            }
        }

        // Funções de backup
        function createBackup() {
            const backupData = {
                transactions: transactions,
                categories: categories,
                accounts: accounts,
                goals: goals,
                backupDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-financeiro-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Backup criado com sucesso!');
        }

        function downloadAllData() {
            const allData = {
                transactions: transactions,
                categories: categories,
                accounts: accounts,
                goals: goals,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `dados-financeiros-completos-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function restoreData() {
            const file = restoreFile.files[0];
            if (!file) {
                alert('Selecione um arquivo para restaurar!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validar dados
                    if (!backupData.transactions || !backupData.categories || !backupData.accounts) {
                        throw new Error('Formato de arquivo inválido!');
                    }
                    
                    if (!confirm('Esta ação substituirá todos os dados atuais. Tem certeza?')) {
                        return;
                    }
                    
                    // Restaurar dados
                    transactions = backupData.transactions;
                    categories = backupData.categories;
                    accounts = backupData.accounts;
                    goals = backupData.goals || [];
                    
                    saveData();
                    loadTransactions();
                    loadPendingTransactions();
                    loadCategories();
                    loadAccounts();
                    loadGoals();
                    updateReports();
                    
                    restoreStatus.textContent = 'Dados restaurados com sucesso!';
                    restoreStatus.style.color = 'var(--success-color)';
                    restoreFile.value = '';
                    restoreBtn.disabled = true;
                    
                    alert('Dados restaurados com sucesso!');
                    
                } catch (error) {
                    console.error('Erro ao restaurar dados:', error);
                    restoreStatus.textContent = 'Erro ao restaurar dados: ' + error.message;
                    restoreStatus.style.color = 'var(--danger-color)';
                }
            };
            
            reader.readAsText(file);
        }

        // Funções de PDF (CORRIGIDAS)
        function downloadReportPDF() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const categoryFilter = document.getElementById('category-filter').value;
            
            if (!startDate || !endDate) {
                alert('Selecione um período para gerar o relatório!');
                return;
            }
            
            // Filtrar transações para o relatório
            let filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                
                return transactionDate >= start && 
                       transactionDate <= end && 
                       !t.isPending &&
                       (categoryFilter === '' || t.categoryId.toString() === categoryFilter);
            });
            
            // Calcular totais
            const income = filteredTransactions
                .filter(t => t.amount > 0)
                .reduce((sum, t) => sum + t.amount, 0);
                
            const expense = filteredTransactions
                .filter(t => t.amount < 0)
                .reduce((sum, t) => sum + t.amount, 0);
                
            const balance = income + expense;
            
            // Criar PDF
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFillColor(86, 54, 211);
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.text('Relatório Financeiro', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Período: ${formatDate(startDate)} à ${formatDate(endDate)}`, 105, 22, { align: 'center' });
            
            // Resumo
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.text('Resumo do Período', 20, 45);
            
            doc.setFontSize(12);
            doc.text(`Receitas: ${formatCurrency(income)}`, 20, 60);
            doc.text(`Despesas: ${formatCurrency(Math.abs(expense))}`, 20, 70);
            doc.setTextColor(balance >= 0 ? 18 : 232, balance >= 0 ? 164 : 63, balance >= 0 ? 84 : 91);
            doc.text(`Saldo: ${formatCurrency(balance)}`, 20, 80);
            doc.setTextColor(0, 0, 0);
            doc.text(`Total de Transações: ${filteredTransactions.length}`, 20, 90);
            
            // Lista de transações
            let yPosition = 110;
            doc.setFontSize(14);
            doc.text('Transações', 20, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            filteredTransactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach((transaction, index) => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    const category = categories.find(c => c.id === transaction.categoryId);
                    const account = accounts.find(a => a.id === transaction.accountId);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.text(formatDate(transaction.date), 20, yPosition);
                    doc.text(transaction.description, 50, yPosition);
                    doc.text(category ? category.name : 'Sem categoria', 120, yPosition);
                    doc.text(account ? account.name : 'Sem conta', 160, yPosition);
                    
                    doc.setTextColor(transaction.amount >= 0 ? 18 : 232, transaction.amount >= 0 ? 164 : 63, transaction.amount >= 0 ? 84 : 91);
                    doc.text(formatCurrency(transaction.amount), 190, yPosition, { align: 'right' });
                    
                    yPosition += 7;
                });
            
            // Rodapé
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Página ${i} de ${totalPages} • Gerado em ${new Date().toLocaleDateString('pt-BR')}`, 105, 290, { align: 'center' });
            }
            
            // Salvar PDF
            doc.save(`relatorio-financeiro-${startDate}-a-${endDate}.pdf`);
        }

        function downloadReceipt() {
            const transactionId = parseInt(document.getElementById('edit-transaction-id').value);
            const transaction = transactions.find(t => t.id === transactionId);
            
            if (!transaction) {
                alert('Transação não encontrada!');
                return;
            }
            
            const category = categories.find(c => c.id === transaction.categoryId);
            const account = accounts.find(a => a.id === transaction.accountId);
            
            // Criar PDF
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFillColor(86, 54, 211);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('RECIBO', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Comprovante de Transação Financeira', 105, 28, { align: 'center' });
            
            // Detalhes da transação
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.text('Detalhes da Transação', 20, 60);
            
            doc.setFontSize(12);
            let yPosition = 80;
            
            doc.text(`Descrição: ${transaction.description}`, 20, yPosition);
            yPosition += 10;
            
            doc.text(`Data: ${formatDate(transaction.date)}`, 20, yPosition);
            yPosition += 10;
            
            doc.text(`Categoria: ${category ? category.name : 'Sem categoria'}`, 20, yPosition);
            yPosition += 10;
            
            doc.text(`Conta: ${account ? account.name : 'Sem conta'}`, 20, yPosition);
            yPosition += 10;
            
            doc.text(`Status: ${transaction.isPending ? 'Pendente' : 'Confirmada'}`, 20, yPosition);
            yPosition += 20;
            
            // Valor
            doc.setFontSize(20);
            doc.setTextColor(transaction.amount >= 0 ? 18 : 232, transaction.amount >= 0 ? 164 : 63, transaction.amount >= 0 ? 84 : 91);
            doc.text('Valor:', 20, yPosition);
            doc.text(formatCurrency(transaction.amount), 190, yPosition, { align: 'right' });
            yPosition += 20;
            
            // Linha de assinatura
            doc.setDrawColor(0, 0, 0);
            doc.line(20, 250, 100, 250);
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Assinatura', 60, 260, { align: 'center' });
            
            // Data e hora de emissão
            doc.setTextColor(150, 150, 150);
            doc.setFontSize(8);
            doc.text(`Emitido em: ${new Date().toLocaleString('pt-BR')}`, 190, 290, { align: 'right' });
            
            // Salvar PDF
            doc.save(`recibo-${transaction.description.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.pdf`);
        }

        // Funções utilitárias
        function formatCurrency(amount) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function calculateDaysLeft(deadline) {
            const today = new Date();
            const deadlineDate = new Date(deadline);
            const diffTime = deadlineDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
    </script>
</body>
</html>
